name: Generate CV PDF

on:
  push:
    branches: [master]
    paths-ignore:
      - 'README.md'
      - 'PROGRESS.md'
      - 'TODO.md'
      - '.gitignore'
  workflow_dispatch: # Allow manual triggering

jobs:
  generate-pdf:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›ï¸ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          
      - name: ğŸ“¦ Install dependencies
        run: |
          pnpm install
          pnpm add puppeteer --save-dev
        env:
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'true'
          
      - name: ğŸ”§ Install system dependencies for Puppeteer
        run: |
          sudo apt-get update
          sudo apt-get install -y libgbm1 libnss3 libatk-bridge2.0-0 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libxss1 libasound2t64
          
      - name: ğŸŒ Install Chrome for Puppeteer
        run: |
          CHROME_PATH=$(npx puppeteer browsers install chrome | grep chrome@ | awk '{print $2}')
          echo "PUPPETEER_EXECUTABLE_PATH=$CHROME_PATH" >> $GITHUB_ENV
          echo "Chrome installed at: $CHROME_PATH"
          
      - name: ğŸ—ï¸ Build React application
        run: |
          npx update-browserslist-db@latest
          pnpm run build
        
      - name: ğŸ“„ Generate PDF
        run: |
          echo "Build directory contents:"
          ls -la build/ || echo "Build directory not found"
          echo "Chrome executable location:"
          which google-chrome || which chromium-browser || echo "Chrome not found in PATH"
          echo "Running PDF generation..."
          node scripts/generate-pdf.js
        env:
          CI: 'true'
          
      - name: ğŸ“Š List generated files
        run: |
          echo "Generated PDF files:"
          ls -la pdfs/*.pdf || echo "No PDF files found in pdfs/"
          
      - name: ğŸ·ï¸ Get version for tag
        id: version
        run: |
          VERSION=$(node -e "
            const fs = require('fs');
            const content = fs.readFileSync('src/constants.js', 'utf8');
            const match = content.match(/CV_VERSION\s*=\s*[\"']([^\"']+)[\"']/);
            console.log(match ? match[1] : 'v1.0');
          ")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=cv-$VERSION-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          
      - name: ğŸš€ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "CV PDF ${{ steps.version.outputs.version }}"
          body: |
            Automatically generated CV PDF from commit: ${{ github.sha }}
            
            **Changes in this version:**
            - Generated from latest CV content
            - Version: ${{ steps.version.outputs.version }}
            - Build date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            - Commit: ${{ github.sha }}
            
            ğŸ“¥ Download the PDF below
          files: |
            pdfs/Mert_Yasin_CV_*.pdf
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: âœ… Success notification
        run: |
          echo "ğŸ‰ PDF generation and release complete!"
          echo "ğŸ“ Release tag: ${{ steps.version.outputs.tag }}"
          echo "ğŸ”— Check releases: ${{ github.server_url }}/${{ github.repository }}/releases"